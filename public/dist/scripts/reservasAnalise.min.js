function horariosDOMCard(reservas){for(let i=0;i<reservas.length;i++)intervaloDias(reservas[i].horarios,reservas[i]._id),intervaloHorarios(reservas[i].horarios,reservas[i]._id)}function intervaloDias(horarios,reservaID){var segmentos=0,intervalos=[],string="";horarios.sort();for(let j=0;j<horarios.length;j++)if(0===j)intervalos.push([horarios[0]]);else{var hora=horarios[j].substr(0,10),horaAnterior=horarios[j-1].substr(0,10);moment(hora).format("YYYY-MM-DD")===moment(horaAnterior).format("YYYY-MM-DD")||moment(hora).format("YYYY-MM-DD")===moment(horaAnterior).add(1,"days").format("YYYY-MM-DD")?intervalos[segmentos].push(horarios[j]):moment(hora).format("YYYY-MM-DD")===moment(horaAnterior).add(3,"days").format("YYYY-MM-DD")?intervalos[segmentos].push(horarios[j]):(segmentos++,intervalos.push([]),intervalos[segmentos].push(horarios[j]))}for(let i=0;i<intervalos.length;i++){var firstDay=intervalos[i][0].substr(0,10),lastDay=intervalos[i][intervalos[i].length-1].substr(0,10);moment(firstDay).add(1,"days").format("DD")===moment(lastDay).format("DD")||5===moment(firstDay).day()&&moment(firstDay).add(3,"days").format("DD")===moment(lastDay).format("DD")?moment(firstDay).format("MM")===moment(lastDay).format("MM")?string+="<p>"+moment(firstDay).format("DD [e] ")+moment(lastDay).format("DD [de] MMM")+"</p>":string+="<p>"+moment(firstDay).format("DD [de] MMM [e] ")+moment(lastDay).format("DD [de] MMM")+"</p>":firstDay===lastDay&&moment(firstDay).add(1,"days").format("MM")===moment(lastDay).format("MM")?string+="<p>"+moment(firstDay).format("DD [de] MMM")+"</p>":moment(firstDay).format("MM")===moment(lastDay).format("MM")?string+="<p>"+moment(firstDay).format("DD [a]")+moment(lastDay).format(" DD [de] MMM")+"</p>":string+="<p>"+moment(firstDay).format("DD [de] MMM [a]")+moment(lastDay).format(" DD [de] MMM")+"</p>"}document.getElementById("horarios-"+reservaID).innerHTML=string}var idReserva,obs,emAnalise=[],body=document.getElementsByTagName("body")[0];let confirmarAcao=(acao,e)=>{if(document.getElementById(`input-${acao}-reserva`).value=e.target.parentElement.parentElement.parentElement.id,variaveisGlobais.controlarVisibilidade("exibir",`#form-${acao}-reserva`),variaveisGlobais.controlarVisibilidade("exibir","#overlay"),body.classList.add("fixo"),"confirmar"===acao){let conflito=document.querySelectorAll(`#detalhes-${e.target.parentElement.parentElement.parentElement.id} .conflito`);for(let i=0;i<conflito.length;i++)document.getElementById("form-confirmar-reserva").insertAdjacentHTML("afterbegin",`\n                <input type="text" name = "excluirReserva" id="excluir-pedido-${conflito[i].dataset.idconflito}" readonly class="hidden" value = ${conflito[i].dataset.idconflito}>`)}};document.querySelector(".analise-requisicoes").addEventListener("click",function(e){e.target.classList.contains("botao")&&e.target.classList.contains("confirmar")&&confirmarAcao("confirmar",e),e.target.classList.contains("botao")&&e.target.classList.contains("recusar")&&confirmarAcao("recusar",e),(e.target.classList.contains("detalhes-plus")||e.target.classList.contains("card-img")||e.target.classList.contains("card-evento"))&&(variaveisGlobais.controlarVisibilidade("exibir","#detalhes-"+e.target.parentElement.parentElement.id),variaveisGlobais.controlarVisibilidade("exibir","#overlay"),body.classList.add("fixo")),e.target.classList.contains("button-fechar")&&(variaveisGlobais.controlarVisibilidade("ocultar",`#${e.target.parentElement.parentElement.id}`),variaveisGlobais.controlarVisibilidade("ocultar","#overlay"),body.classList.remove("fixo"))}),document.getElementById("form-recusar-reserva").addEventListener("click",function(e){e.target.classList.contains("retornar")&&(e.preventDefault(),document.getElementById("input-confirmar-reserva").value="",variaveisGlobais.controlarVisibilidade("ocultar","#form-recusar-reserva"),variaveisGlobais.controlarVisibilidade("ocultar","#overlay"),body.classList.remove("fixo"))}),document.getElementById("form-confirmar-reserva").addEventListener("click",function(e){e.target.classList.contains("retornar")&&(e.preventDefault(),document.getElementById("input-confirmar-reserva").value="",variaveisGlobais.controlarVisibilidade("ocultar","#form-confirmar-reserva"),variaveisGlobais.controlarVisibilidade("ocultar","#overlay"),body.classList.remove("fixo"))});var statusRequisicoes=function(reservas){var requisitado=!1,agendado=!1;for(let i=0;i<reservas.length;i++){if("requisitado"===reservas[i].status){if(requisitado)continue;requisitado=!0}if("agendado"===reservas[i].status){if(agendado)continue;agendado=!0}}requisitado||(document.querySelector(".status-requisicoes").innerHTML="Não há requisições pendentes"),agendado||(document.querySelector(".status-agendados").innerHTML="Não há eventos previstos")},pedidosDiv=function(seletor,arrayDados){let html="";for(let i=0;i<arrayDados.length;i++){let conflitosDOM="",alertaConflito="",conflitosHorario=concomitancias(arrayDados[i]._id,arrayDados[i].auditorio,arrayDados[i].horarios,arrayDados);if(0===conflitosHorario.length)conflitosDOM="";else{alertaConflito="<i class='fa fa-exclamation-triangle icone-conflito'></i><span class='dica conflito-dica'>Há conflito de horário com outros pedidos. Confira os pedidos concomitantes na guia \"+ detalhes\"</span>",conflitosDOM='<div class="conflitos-horario-div"><p> <strong> Conflitos de horário:</strong></p>';for(let i=0;i<conflitosHorario.length;i++)conflitosDOM+=`<p class='conflito' data-idconflito='${conflitosHorario[i]._id}'>${conflitosHorario[i].evento}</p>`;conflitosDOM+="</div>"}let botoes,registros="";for(let j=0;j<arrayDados[i].registros.length;j++){registros+=`<p><strong>${moment(arrayDados[i].registros[j].data).format("DD/MM/YYYY HH:mm")}</strong> | ${arrayDados[i].registros[j].texto}</p>`}botoes=".requisicoes-reservas-div"===seletor?'<div class="card-buttons">\n            <button class="botao confirmar">confirmar</button>\n            <button class="botao recusar">recusar</button>\n            </div>':'<div class="card-buttons">\n            <button class="botao recusar">cancelar reserva</button>\n            </div>',arrayDados[i].observacoes||(arrayDados[i].observacoes=""),html+=`        \n        <div class="card" id="${arrayDados[i]._id}" data-auditorio=${arrayDados[i].auditorio}>\n            <div class="card-cabecalho">\n                ${alertaConflito}\n                <div class="card-img ${arrayDados[i].auditorio}">\n                </div>\n                <h3 class="card-evento">${arrayDados[i].evento}</h3>\n            </div>\n            <div class="card-body">\n                <h3 class="natureza">${arrayDados[i].naturezaEvento}</h3>\n                <div class="resumo-horarios" id="horarios-${arrayDados[i]._id}">\n                </div>\n                ${botoes}\n                <div class="detalhes-plus">\n                    <i class="fa fa-plus"></i>\n                    <span>detalhes</span>\n                </div>\n            </div>\n            <div class="janela hidden opacidade-zero" id="detalhes-${arrayDados[i]._id}">                \n                <h2 class="header">Detalhamento do pedido:</h2>\n                <p> <strong> Evento:</strong> ${arrayDados[i].evento}</p>\n                <p> <strong> Responsável:</strong> ${arrayDados[i].nomeResponsavel}</p>\n                <p> <strong> Auditório:</strong> ${arrayDados[i].auditorioNome}</p>\n                <p> <strong> Público:</strong> ${arrayDados[i].publico} pessoas</p>\n                <p> <strong> Natureza do evento:</strong> ${arrayDados[i].naturezaEvento}</p>\n                <p> <strong> Especificações do pedido:</strong> ${arrayDados[i].informacoesComplementares}</p>\n                <div class="detalhes-horarios-${arrayDados[i]._id}">        \n                    <p><strong> Horários:</strong></p>                    \n                </div>\n                <p>${conflitosDOM}</p>\n                <div class="div-registros"> \n                    ${registros}\n                </div>\n                <div class="observacoes observacoes-${arrayDados[i]._id}">\n                    <div class="formulario">\n                        <label for="obs"><p>observações:</p></label>\n                        <textarea id="obs-${arrayDados[i]._id}" name="obs" value="${arrayDados[i].observacoes}">${arrayDados[i].observacoes}</textarea>\n                    </div>\n                    <div class="button-div">\n                        <button class="salvar-observacoes">Salvar observações</button>\n                    </div>\n                </div>\n                <div class="button-div">\n                    <button class="button-fechar">voltar</button>\n                </div>\n            </div>\n        </div>`}document.querySelector(seletor).insertAdjacentHTML("beforeend",html)},intervaloHorarios=function(horarios,reservaID){var reserva;horarios.sort(),reserva=`<div class = "reserva"><p><strong>${moment(horarios[0].substring(0,10)).format("DD [de] MMMM")}</strong><hr style="background-color: #ccc; width: 90%"></p>`,reserva+=`<span>${horarios[0].substring(11,13)}:00 - ${variaveisGlobais.horaFim(Number(horarios[0].substring(11,13)))}:00</span><br>`;for(let k=1;k<horarios.length;k++){var horario=horarios[k].substring(11,13);horarios[k].substring(0,10)===horarios[k-1].substring(0,10)?reserva+=`<span>${horario}:00 - ${variaveisGlobais.horaFim(Number(horario))}:00</span><br>`:(reserva+="</div>",reserva+=`<div class = reserva><p><strong>${moment(horarios[k].substring(0,10)).format("DD [de] MMMM")}</strong><hr style="background-color: #ccc; width: 90%"></p>`,reserva+=`<span>${horario}:00 - ${variaveisGlobais.horaFim(Number(horario))}:00</span><br>`)}reserva+="</div>",document.querySelector(".detalhes-horarios-"+reservaID).innerHTML=reserva};let concomitancias=(id,auditorio,horarios,reservas)=>{let reservasDoAuditorio=[],reservasConflitantes=[];for(let i=0;i<reservas.length;i++)reservas[i].auditorio===auditorio&&reservas[i]._id!==id&&reservasDoAuditorio.push(reservas[i]);for(let i=0;i<reservasDoAuditorio.length;i++){let conflitante=!1;for(let j=0;j<reservasDoAuditorio[i].horarios.length;j++){for(let k=0;k<horarios.length;k++)if(reservasDoAuditorio[i].horarios[j]===horarios[k]){reservasConflitantes.push(reservasDoAuditorio[i]),conflitante=!0;break}if(conflitante)break}}return reservasConflitantes};window.addEventListener("DOMContentLoaded",async function(e){let todasRequisicoes=await variaveisGlobais.ajax("/reserva/analise/requisicoes","get");pedidosDiv(".requisicoes-reservas-div",todasRequisicoes[0]),pedidosDiv(".requisicoes-agendados-div",todasRequisicoes[1]);let todosHorarios=await variaveisGlobais.ajax("/recuperarHorarios","get");await variaveisGlobais.checarAtividades(todosHorarios);statusRequisicoes(todosHorarios),horariosDOMCard(todosHorarios),document.querySelector(".analise-requisicoes").addEventListener("click",async function(e){if(e.target.classList.contains("salvar-observacoes")){e.preventDefault(),idReserva=e.target.parentElement.parentElement.parentElement.id.split("-")[1],obs=document.getElementById(`obs-${idReserva}`).value;var editada=await variaveisGlobais.ajax("/reserva/editar","post",{id:idReserva,obs});document.getElementById(`obs-${idReserva}`).value=editada.observacoes,variaveisGlobais.exibirMensagem("As observações da reserva foram salvas",2500)}})});